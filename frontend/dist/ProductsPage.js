import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import { useState, useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import { Link } from 'react-router-dom';
import { productService } from './services/productService';
import { Search, Filter, Plus, FileDown, FileUp, AlertTriangle } from 'lucide-react';
import { useAuth } from './hooks/useAuth';
const ProductsPage = () => {
    const { user } = useAuth();
    const isAdmin = (user === null || user === void 0 ? void 0 : user.role) === 'admin' || (user === null || user === void 0 ? void 0 : user.role) === 'ADMIN';
    const [filters, setFilters] = useState({
        search: '',
        category: '',
        brand: '',
        location: '',
        lowStock: false
    });
    const [categories, setCategories] = useState([]);
    const [brands, setBrands] = useState([]);
    const [locations, setLocations] = useState([]);
    const { data: products = [], isLoading, error, refetch } = useQuery({
        queryKey: ['products', filters],
        queryFn: () => productService.getProducts(filters)
    });
    // 카테고리, 브랜드, 위치 목록 추출
    useEffect(() => {
        if (products.length > 0) {
            const uniqueCategories = [...new Set(products.map(p => p.category))];
            const uniqueBrands = [...new Set(products.map(p => p.brand))];
            const uniqueLocations = [...new Set(products.map(p => p.location))];
            setCategories(uniqueCategories);
            setBrands(uniqueBrands);
            setLocations(uniqueLocations);
        }
    }, [products]);
    const handleSearchChange = (e) => {
        setFilters((prev) => ({ ...prev, search: e.target.value }));
    };
    const handleFilterChange = (e) => {
        const { name, value } = e.target;
        setFilters((prev) => ({ ...prev, [name]: value }));
    };
    const handleLowStockToggle = (e) => {
        setFilters((prev) => ({ ...prev, lowStock: e.target.checked }));
    };
    const handleExport = () => {
        const exportUrl = productService.getExportUrl(filters);
        window.open(exportUrl, '_blank');
    };
    return (_jsxs("div", { className: "container mx-auto px-4", children: [_jsxs("div", { className: "flex flex-col md:flex-row md:items-center md:justify-between mb-6", children: [_jsx("h1", { className: "text-2xl font-bold text-gray-900 mb-4 md:mb-0", children: "\uC81C\uD488 \uAD00\uB9AC" }), _jsx("div", { className: "flex flex-col sm:flex-row gap-2", children: isAdmin && (_jsxs(_Fragment, { children: [_jsxs("button", { onClick: handleExport, className: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500", children: [_jsx(FileDown, { className: "h-4 w-4 mr-2" }), "CSV \uB0B4\uBCF4\uB0B4\uAE30"] }), _jsxs(Link, { to: "/products/upload", className: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500", children: [_jsx(FileUp, { className: "h-4 w-4 mr-2" }), "\uB300\uB7C9 \uC5C5\uB85C\uB4DC"] }), _jsxs(Link, { to: "/products/new", className: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-kyobo hover:bg-kyobo-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-kyobo", children: [_jsx(Plus, { className: "h-4 w-4 mr-2" }), "\uC2E0\uADDC \uC81C\uD488"] })] })) })] }), _jsxs("div", { className: "bg-white shadow rounded-lg mb-6", children: [_jsx("div", { className: "p-4 border-b border-gray-200", children: _jsxs("h2", { className: "text-lg font-medium text-gray-900 flex items-center", children: [_jsx(Filter, { className: "h-5 w-5 mr-2 text-gray-500" }), "\uAC80\uC0C9 \uBC0F \uD544\uD130"] }) }), _jsx("div", { className: "p-4", children: _jsxs("div", { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4", children: [_jsxs("div", { className: "relative", children: [_jsx("div", { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none", children: _jsx(Search, { className: "h-5 w-5 text-gray-400" }) }), _jsx("input", { type: "text", name: "search", value: filters.search, onChange: handleSearchChange, placeholder: "\uC0C1\uD488\uBA85 \uB610\uB294 SKU \uAC80\uC0C9", className: "block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-kyobo focus:border-kyobo sm:text-sm" })] }), _jsx("div", { children: _jsxs("select", { name: "category", value: filters.category, onChange: handleFilterChange, className: "block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-kyobo focus:border-kyobo sm:text-sm", children: [_jsx("option", { value: "", children: "\uBAA8\uB4E0 \uCE74\uD14C\uACE0\uB9AC" }), categories.map(category => (_jsx("option", { value: category, children: category }, category)))] }) }), _jsx("div", { children: _jsxs("select", { name: "brand", value: filters.brand, onChange: handleFilterChange, className: "block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-kyobo focus:border-kyobo sm:text-sm", children: [_jsx("option", { value: "", children: "\uBAA8\uB4E0 \uBE0C\uB79C\uB4DC" }), brands.map(brand => (_jsx("option", { value: brand, children: brand }, brand)))] }) }), _jsx("div", { children: _jsxs("select", { name: "location", value: filters.location, onChange: handleFilterChange, className: "block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-kyobo focus:border-kyobo sm:text-sm", children: [_jsx("option", { value: "", children: "\uBAA8\uB4E0 \uC704\uCE58" }), locations.map(location => (_jsx("option", { value: location, children: location }, location)))] }) }), _jsxs("div", { className: "flex items-center", children: [_jsx("input", { id: "lowStock", name: "lowStock", type: "checkbox", checked: filters.lowStock, onChange: handleLowStockToggle, className: "h-4 w-4 text-kyobo focus:ring-kyobo border-gray-300 rounded" }), _jsx("label", { htmlFor: "lowStock", className: "ml-2 block text-sm text-gray-900", children: "\uC800\uC7AC\uACE0 \uC0C1\uD488\uB9CC \uBCF4\uAE30" })] })] }) })] }), isLoading ? (_jsx("div", { className: "flex justify-center items-center h-64", children: _jsx("div", { className: "animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-kyobo" }) })) : error ? (_jsx("div", { className: "bg-red-50 border-l-4 border-red-400 p-4 mb-6", children: _jsxs("div", { className: "flex", children: [_jsx("div", { className: "flex-shrink-0", children: _jsx(AlertTriangle, { className: "h-5 w-5 text-red-400" }) }), _jsx("div", { className: "ml-3", children: _jsx("p", { className: "text-sm text-red-700", children: "\uC81C\uD488 \uBAA9\uB85D\uC744 \uBD88\uB7EC\uC624\uB294 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4. \uB2E4\uC2DC \uC2DC\uB3C4\uD574\uC8FC\uC138\uC694." }) })] }) })) : (_jsx(_Fragment, { children: products.length === 0 ? (_jsx("div", { className: "bg-white shadow rounded-lg p-6 text-center", children: _jsx("p", { className: "text-gray-500", children: "\uAC80\uC0C9 \uACB0\uACFC\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4." }) })) : (_jsx("div", { className: "bg-white shadow overflow-hidden rounded-lg", children: _jsx("div", { className: "overflow-x-auto", children: _jsxs("table", { className: "min-w-full divide-y divide-gray-200", children: [_jsx("thead", { className: "bg-gray-50", children: _jsxs("tr", { children: [_jsx("th", { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", children: "SKU" }), _jsx("th", { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", children: "\uC0C1\uD488\uBA85" }), _jsx("th", { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", children: "\uCE74\uD14C\uACE0\uB9AC" }), _jsx("th", { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", children: "\uBE0C\uB79C\uB4DC" }), _jsx("th", { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", children: "\uC704\uCE58" }), _jsx("th", { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", children: "\uC218\uB7C9" }), _jsx("th", { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", children: "\uB2E8\uAC00" }), _jsx("th", { scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", children: "\uC791\uC5C5" })] }) }), _jsx("tbody", { className: "bg-white divide-y divide-gray-200", children: products.map((product) => (_jsxs("tr", { className: "hover:bg-gray-50", children: [_jsx("td", { className: "px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900", children: product.sku }), _jsx("td", { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-500", children: _jsx(Link, { to: `/products/${product.id}`, className: "text-kyobo hover:underline", children: product.name }) }), _jsx("td", { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-500", children: product.category }), _jsx("td", { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-500", children: product.brand }), _jsx("td", { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-500", children: product.location }), _jsx("td", { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-500", children: _jsxs("span", { className: `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${product.quantity <= product.safetyStock
                                                        ? 'bg-red-100 text-red-800'
                                                        : 'bg-green-100 text-green-800'}`, children: [product.quantity, " / ", product.safetyStock] }) }), _jsxs("td", { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-500", children: [product.price.toLocaleString(), "\uC6D0"] }), _jsx("td", { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-500", children: _jsxs("div", { className: "flex space-x-2", children: [_jsx(Link, { to: `/products/${product.id}`, className: "text-indigo-600 hover:text-indigo-900", children: "\uC0C1\uC138" }), _jsx(Link, { to: `/products/${product.id}/adjust`, className: "text-green-600 hover:text-green-900", children: "\uC785/\uCD9C\uACE0" }), _jsx(Link, { to: `/products/${product.id}/move`, className: "text-blue-600 hover:text-blue-900", children: "\uC704\uCE58\uBCC0\uACBD" })] }) })] }, product.id))) })] }) }) })) }))] }));
};
export default ProductsPage;
